<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何创建一个 Angular 的库 | cj0x39e</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="https://www.googletagmanager.com/gtag/js?id=G-1PWBM2M60V" async="true"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1PWBM2M60V');
      </script>
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.387d7566.css" as="style"><link rel="preload" href="/assets/js/app.bba036ff.js" as="script"><link rel="preload" href="/assets/js/5.981055af.js" as="script"><link rel="preload" href="/assets/js/17.74a7cce4.js" as="script"><link rel="prefetch" href="/assets/js/10.e7b08e66.js"><link rel="prefetch" href="/assets/js/11.a3557a6f.js"><link rel="prefetch" href="/assets/js/12.c8813de3.js"><link rel="prefetch" href="/assets/js/13.f3a37fca.js"><link rel="prefetch" href="/assets/js/14.563b17b5.js"><link rel="prefetch" href="/assets/js/15.1f55af88.js"><link rel="prefetch" href="/assets/js/16.b8240ea5.js"><link rel="prefetch" href="/assets/js/18.c619dcba.js"><link rel="prefetch" href="/assets/js/2.3da3fbd1.js"><link rel="prefetch" href="/assets/js/3.7e5f800c.js"><link rel="prefetch" href="/assets/js/4.cee37886.js"><link rel="prefetch" href="/assets/js/6.e9fb628d.js"><link rel="prefetch" href="/assets/js/7.4683c2f5.js"><link rel="prefetch" href="/assets/js/8.7613bb7f.js"><link rel="prefetch" href="/assets/js/9.e3021c92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.387d7566.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container vuepress-theme-simple"><header class="header"><a href="/" title="" class="site-name router-link-active">
      cj0x39e
      
    </a> <div style="clear: both"></div> <!----></header> <section class="post-view"><div class="post-head"><h1 class="post-title">
      如何创建一个 Angular 的库
    </h1></div> <div class="post-sub-head"><time datetime="6/14/2018, 12:00:00 AM" title="6/14/2018, 12:00:00 AM" pubdate="pubdate" class="post-date">
  3 years ago
</time></div> <div class="content__default"><p>本文基于 <code>angular-cli</code> 6.x 提供的 <code>Library</code> 相关命令。</p> <p>我们创建一个名叫 <code>hello-ui</code> 的库，该库包含以下功能：</p> <ul><li>一个按钮 <code>component</code></li></ul> <p><a href="https://github.com/taozhiw/hello-ui" target="_blank" rel="noopener noreferrer">示例项目代码: https://github.com/taozhiw/hello-ui<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="创建库的工作空间"><a href="#创建库的工作空间" class="header-anchor">#</a> 创建库的工作空间</h2> <p><code>Library</code> 不能独立创建(<a href="https://github.com/angular/angular-cli/issues/10929" target="_blank" rel="noopener noreferrer">关于该设计的相关讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，以下是 Angular 团队成员的解释：</p> <blockquote><p>There isn't a flag to do this on ng new but it is something we have discussed. I'd like to point out that usually one would want to test their libraries on a real app while developing though.</p></blockquote> <p>使用 <code>ng new</code> 命令创建 <code>hello-ui-wrap</code> 项目（以下该项目称为工作空间）：</p> <div class="language-base extra-class"><pre class="language-text"><code>ng new hello-ui-wrap --style=scss
</code></pre></div><p><code>--style</code> 可指定项目使用的样式预编译语言，其它 <code>ng new</code> 的参数可使用 <code>ng new --help</code> 查看，这样我们的工作空间就创建好了。项目创建完成 <code>angular-cli</code> 会自动使用 <code>npm</code> 安装相关依赖包，一般我会强制停掉使用 <code>yarn</code> 安装。安装完成，便可以使用 <code>npm run start</code> 启动，然后在浏览器打开 http://localhost:4200/ 便可以看到欢迎界面了。</p> <h2 id="创建库"><a href="#创建库" class="header-anchor">#</a> 创建库</h2> <p>使用 <code>ng generate</code> 命令:</p> <div class="language-base extra-class"><pre class="language-text"><code>ng generate library hello-ui --prefix=hu
</code></pre></div><p><code>--prefix=hu</code> 指定了该库的组件名的前缀，一般如果库提供了组件的话，都是需要指定的。还有其它参数同样可使用 <code>ng generate library --help</code> 查看。命令执行完毕后，工作空间中多了一个 <code>projects</code> 文件夹，该文件夹中的 <code>hello-ui</code> 便是我们创建的库了，从目录的结构就可以看出，一个工作空间中是可以创建多个库的。</p> <p>接着删掉库里面的 <code>hello-ui.component.spec.ts</code>、<code>hello-ui.component.ts</code>、<code>hello-ui.service.spec.ts</code>、<code>hello-ui.service.ts</code> 文件，及清除掉 <code>hello-ui.module.ts</code>、<code>public_api.ts</code> 对于这几个文件的引用代码。因为后续我们不会用到。</p> <h2 id="创建库的组件"><a href="#创建库的组件" class="header-anchor">#</a> 创建库的组件</h2> <p>为了让组件能够按需导出 <code>module</code>，我们给每个组件都创建一个 <code>module</code>，对于 <code>pipe</code>、<code>directive</code> 等我们都可以为其建立单独的 <code>module</code>。</p> <p>首先创建按钮模块，转到 <code>hello-ui/src/lib</code> 目录下（如果不切换目录，在工作空间下创建库的部件，需要加上 --project=hello-ui），执行创建模块的命令:</p> <div class="language-base extra-class"><pre class="language-text"><code>ng generate module button
</code></pre></div><p>命令执行完成后可看到在 <code>hello-ui/src/lib</code> 下多了一个 <code>hello</code> 文件夹，接着创建我们的按钮组件:</p> <div class="language-base extra-class"><pre class="language-text"><code>ng generate component button
</code></pre></div><p>创建完成后，修改 <code>button.component.html</code> 的内容为下面的内容:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>我是 hello-ui 的 button<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>修改 <code>button.module.ts</code> ：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">NgModule</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>CommonModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>ButtonComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// 注意，必须 exports 出去，不然调用时会报找不到相关组件</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>ButtonComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ButtonModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>修改 <code>hello-ui.module.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">NgModule</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>ButtonModule<span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// 同样必须导出</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>ButtonModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloUiModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>修改 <code>public_api.ts</code>：</p> <p>库对外的东西都需要在此声明，不声明调用会报错。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./lib/hello-ui.module&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./lib/button/button.module&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./lib/button/button.component&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="打包库"><a href="#打包库" class="header-anchor">#</a> 打包库</h2> <p>很简单，在 <code>package.json</code> 中加一个脚本配置:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">&quot;build:lib&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ng build --prod hello-ui&quot;</span><span class="token punctuation">,</span>
    ...
<span class="token punctuation">}</span>
</code></pre></div><p>然后使用 <code>npm run build:lib</code> 或者 <code>yarn build:lib</code> 运行该命令，运行结束，就可以在工作空间下看到多了个 <code>dist</code> 目录, 在 <code>dist</code> 目录下的 <code>hello-ui</code> 文件夹便是打包后的目录。</p> <h3 id="在工作空间中使用库"><a href="#在工作空间中使用库" class="header-anchor">#</a> 在工作空间中使用库</h3> <p>像使用其它 npm 包一样，在 <code>app.module.ts</code> 中导入即可：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./app.component&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 按需导入（虽然目前看起来没什么用，因为库里面就一个组件）</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ButtonModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hello-ui&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 或者整个库导入</span>
<span class="token comment">// import { HelloUiModule } from 'hello-ui';</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">NgModule</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>BrowserModule<span class="token punctuation">,</span> ButtonModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>然后修改下 <code>app.component.html</code>，加上我们自己组件的调用：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hu-button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hu-button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后重启服务，就可以看到我们的库已经可以调用了。</p> <p>为什么我们的库能像 npm 安装的包一样导入，是因为我们在生成库的时候，<code>angular-cli</code> 帮我们在 <code>tsconfig.json</code> 中加上了下面的内容:</p> <div class="language-json extra-class"><pre class="language-json"><code>    <span class="token property">&quot;paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hello-ui&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;dist/hello-ui&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hello-ui/*&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;dist/hello-ui/*&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>所以 Angular 在编译时，就会先从配置的 <code>paths</code> 去查找，然后再去 <code>node_modules</code> 去查找。</p> <h2 id="发布库"><a href="#发布库" class="header-anchor">#</a> 发布库</h2> <p>切换到 <code>dist/hello-ui</code> 下执行 <code>npm publish</code> (<a href="https://docs.npmjs.com/getting-started/publishing-npm-packages" target="_blank" rel="noopener noreferrer">关于 npm publish<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) 就行了。</p> <h2 id="其它"><a href="#其它" class="header-anchor">#</a> 其它</h2> <h3 id="给库增加依赖包"><a href="#给库增加依赖包" class="header-anchor">#</a> 给库增加依赖包</h3> <p>如果库有依赖包，我们在其 <code>package.json</code> 的 <code>dependencies</code> 字段中配置下，还没有完，还需要在
<code>ng-package.json</code> 中配置下 <code>whitelistedNonPeerDependencies</code> (<a href="https://github.com/dherges/ng-packagr/issues/716" target="_blank" rel="noopener noreferrer">关于 whitelistedNonPeerDependencies 的相关讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，例如我们的库依赖 <code>clone</code> 这个库，则需要配置:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;whitelistedNonPeerDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>参考资料：</p> <ul><li><p><a href="https://blog.angular.io/version-6-of-angular-now-available-cc56b0efa7a4" target="_blank" rel="noopener noreferrer">Version 6 of Angular Now Available<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://github.com/angular/angular-cli/wiki/stories-create-library" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://blog.angularindepth.com/creating-a-library-in-angular-6-87799552e7e5" target="_blank" rel="noopener noreferrer">creating-a-library-in-angular<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <div></div></section> <footer class="footer"><p class="text">© 2021 cj0x39e / I konw nothing</p></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bba036ff.js" defer></script><script src="/assets/js/5.981055af.js" defer></script><script src="/assets/js/17.74a7cce4.js" defer></script>
  </body>
</html>
